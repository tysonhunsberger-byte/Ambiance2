import{P as O,g as ue,d as He,D as _e,x as ne,E as Oe,F as ze,n as Le,u as We,z as De,G as $e}from"./index.CqaByfe5.js";const te=(n="test-canvas",e)=>{let{contextType:t="2d",pixelated:o=!1,pixelRatio:r=window.devicePixelRatio}=e||{},i=document.querySelector("#"+n);if(!i){i=document.createElement("canvas"),i.id=n,i.width=window.innerWidth*r,i.height=window.innerHeight*r,i.style="pointer-events:none;width:100%;height:100%;position:fixed;top:0;left:0",o&&(i.style.imageRendering="pixelated"),document.body.prepend(i);let a;window.addEventListener("resize",()=>{a&&clearTimeout(a),a=setTimeout(()=>{i.width=window.innerWidth*r,i.height=window.innerHeight*r},200)})}return i.getContext(t,{willReadFrequently:!0})};let Q={};function we(n){Q[n]!==void 0&&(cancelAnimationFrame(Q[n]),delete Q[n])}function Ne(n){Object.keys(Q).forEach(e=>(!n||e.startsWith(n))&&we(e))}let _={};O.prototype.draw=function(n,e){if(typeof window>"u")return this;let{id:t=1,lookbehind:o=0,lookahead:r=0}=e,i=Math.max(ue(),0);we(t),o=Math.abs(o),_[t]=(_[t]||[]).filter(p=>!p.isInFuture(i));let a=this.queryArc(i,i+r).filter(p=>p.hasOnset());_[t]=_[t].concat(a);let c;const s=()=>{const p=ue(),d=p+r;_[t]=_[t].filter(u=>u.isInNearPast(o,p));let h=Math.max(c||d,d-1/10);const g=this.queryArc(h,d).filter(u=>u.hasOnset());_[t]=_[t].concat(g),c=d,n(_[t],p,d,this),Q[t]=requestAnimationFrame(s)};return Q[t]=requestAnimationFrame(s),this};const Je=(n=!0,e)=>{const t=te();n&&t.clearRect(0,0,t.canvas.width,t.canvas.height),Ne(e)};O.prototype.onPaint=function(n){return this.withState(e=>{e.controls.painters||(e.controls.painters=[]),e.controls.painters.push(n)})};O.prototype.getPainters=function(){let n=[];return this.queryArc(0,0,{painters:n}),n};class je{constructor(e,t){this.onFrame=e,this.onError=t}start(){const e=this;let t=requestAnimationFrame(function o(r){try{e.onFrame(r)}catch(i){e.onError(i)}t=requestAnimationFrame(o)});e.cancel=()=>{cancelAnimationFrame(t)}}stop(){this.cancel&&this.cancel()}}class Ze{constructor(e,t){this.visibleHaps=[],this.lastFrame=null,this.drawTime=t,this.painters=[],this.framer=new je(()=>{if(!this.scheduler){console.warn("Drawer: no scheduler");return}const o=Math.abs(this.drawTime[0]),r=this.drawTime[1],i=this.scheduler.now()+r;if(this.lastFrame===null){this.lastFrame=i;return}const a=this.scheduler.pattern.queryArc(Math.max(this.lastFrame,i-1/10),i);this.lastFrame=i,this.visibleHaps=(this.visibleHaps||[]).filter(s=>s.whole&&s.endClipped>=i-o-r).concat(a.filter(s=>s.hasOnset()));const c=i-r;e(this.visibleHaps,c,this,this.painters)},o=>{console.warn("draw error",o)})}setDrawTime(e){this.drawTime=e}invalidate(e=this.scheduler,t){if(!e)return;t=t??e.now(),this.scheduler=e;let[o,r]=this.drawTime;const[i,a]=[Math.max(t,0),t+r+.1];this.visibleHaps=this.visibleHaps.filter(s=>s.whole?.begin<t),this.painters=[];const c=e.pattern.queryArc(i,a,{painters:this.painters});this.visibleHaps=this.visibleHaps.concat(c)}start(e){this.scheduler=e,this.invalidate(),this.framer.start()}stop(){this.framer&&this.framer.stop()}}function xe(n){return typeof window>"u"?"#fff":getComputedStyle(document.documentElement).getPropertyValue(n)}let ve={background:"#222",foreground:"#75baff",caret:"#ffcc00",selection:"rgba(128, 203, 196, 0.5)",selectionMatch:"#036dd626",lineHighlight:"#00000050",gutterBackground:"transparent",gutterForeground:"#8a919966"};function $(){return ve}function et(n){ve=n}let fe="#22222210";O.prototype.animate=function({callback:n,sync:e=!1,smear:t=.5}={}){window.frame&&cancelAnimationFrame(window.frame);const o=te();let{clientWidth:r,clientHeight:i}=o.canvas;r*=window.devicePixelRatio,i*=window.devicePixelRatio;let a=t===0?"99":Number((1-t)*100).toFixed(0);a=a.length===1?`0${a}`:a,fe=`#200010${a}`;const c=s=>{let p;s=Math.round(s),p=this.slow(1e3).queryArc(s,s),o.fillStyle=fe,o.fillRect(0,0,r,i),p.forEach(d=>{let{x:h,y:g,w:u,h:v,s:y,r:P,angle:f=0,fill:q="darkseagreen"}=d.value;if(u*=r,v*=i,P!==void 0&&f!==void 0){const b=f*2*Math.PI,[w,T]=[(r-u)/2,(i-v)/2];h=w+Math.cos(b)*P*w,g=T+Math.sin(b)*P*T}else h*=r-u,g*=i-v;const k={...d.value,x:h,y:g,w:u,h:v};o.fillStyle=q,y==="rect"?o.fillRect(h,g,u,v):y==="ellipse"&&(o.beginPath(),o.ellipse(h+u/2,g+v/2,u/2,v/2,0,0,2*Math.PI),o.fill()),n&&n(o,k,d)}),window.frame=requestAnimationFrame(c)};return window.frame=requestAnimationFrame(c),He};const{x:be,y:tt,w:nt,h:ot,angle:rt,r:it,fill:at,smear:st}=_e("x","y","w","h","angle","r","fill","smear"),lt=ne("rescale",function(n,e){return e.mul(be(n).w(n).y(n).h(n))}),ct=ne("moveXY",function(n,e,t){return t.add(be(n).y(e))}),ht=ne("zoomIn",function(n,e){const t=Oe(1).sub(n).div(2);return e.rescale(n).move(t,t)}),G=(n,e,t)=>n*(t-e)+e,de=n=>{let{value:e}=n;typeof n.value!="object"&&(e={value:e});let{note:t,n:o,freq:r,s:i}=e;if(r)return ze(r);if(t=t??o,typeof t=="string")try{return Le(t)}catch{return 0}return typeof t=="number"?t:i?"_"+i:e};O.prototype.pianoroll=function(n={}){let{cycles:e=4,playhead:t=.5,overscan:o=0,hideNegative:r=!1,ctx:i=te(),id:a=1}=n,c=-e*t,s=e*(1-t);const p=(d,h)=>(!r||d.whole.begin>=0)&&d.isWithinTime(h+c,h+s);return this.draw((d,h)=>{oe({...n,time:h,ctx:i,haps:d.filter(g=>p(g,h))})},{lookbehind:c-o,lookahead:s+o,id:a}),this};function ut(n){return We(n)?n.pianoroll():e=>e.pianoroll(n)}function oe({time:n,haps:e,cycles:t=4,playhead:o=.5,flipTime:r=0,flipValues:i=0,hideNegative:a=!1,inactive:c=$().foreground,active:s=$().foreground,background:p="transparent",smear:d=0,playheadColor:h=$().foreground,minMidi:g=10,maxMidi:u=90,autorange:v=0,timeframe:y,fold:P=1,vertical:f=0,labels:q=!1,fill:k=1,fillActive:b=!1,strokeActive:w=!0,stroke:T,hideInactive:I=0,colorizeInactive:F=1,fontFamily:E,ctx:l,id:L}={}){const A=l.canvas.width,R=l.canvas.height;let W=-t*o,X=t*(1-o);L&&(e=e.filter(m=>m.hasTag(L))),y&&(console.warn("timeframe is deprecated! use from/to instead"),W=0,X=y);const N=f?R:A,H=f?A:R;let D=f?[N,0]:[0,N];const K=X-W,re=f?[0,H]:[H,0];let J=u-g+1,j=H/J,Z=[];r&&D.reverse(),i&&re.reverse();const{min:Te,max:Ae,values:ke}=e.reduce(({min:m,max:M,values:Y},B)=>{const S=de(B);return{min:S<m?S:m,max:S>M?S:M,values:Y.includes(S)?Y:[...Y,S]}},{min:1/0,max:-1/0,values:[]});v&&(g=Te,u=Ae,J=u-g+1),Z=ke.sort((m,M)=>typeof m=="number"&&typeof M=="number"?m-M:typeof m=="number"?1:String(m).localeCompare(String(M))),j=P?H/Z.length:H/J,l.fillStyle=p,l.globalAlpha=1,d||(l.clearRect(0,0,A,R),l.fillRect(0,0,A,R)),e.forEach(m=>{const M=m.whole.begin<=n&&m.endClipped>n;let Y=T??(w&&M),B=!M&&k||M&&b;if(I&&!M)return;let S=m.value?.color;s=S||s,c=F&&S||c,S=M?s:c,l.fillStyle=B?S:"transparent",l.strokeStyle=S;const{velocity:Fe=1,gain:Me=1}=m.value||{};l.globalAlpha=Fe*Me;const Se=(m.whole.begin-(r?X:W))/K,ie=G(Se,...D);let U=G(m.duration/K,0,N);const ae=de(m),qe=P?Z.indexOf(ae)/Z.length:(Number(ae)-g)/J,se=G(qe,...re);let le=0;const ce=G(n/K,...D);let V;if(f?V=[se+1-(i?j:0),N-ce+ie+le+1-(r?0:U),j-2,U-2]:V=[ie-ce+le+1-(r?U:0),se+1-(i?0:j),U-2,j-2],Y&&l.strokeRect(...V),B&&l.fillRect(...V),q){const Ee=m.value.note??m.value.s+(m.value.n?`:${m.value.n}`:""),{label:he,activeLabel:Ce}=m.value,Ie=(M&&Ce||he)??Ee;let Re=f?U:j*.75;l.font=`${Re}px ${E||"monospace"}`,l.fillStyle=B?"black":S,l.textBaseline="top",l.fillText(Ie,...V)}}),l.globalAlpha=1;const x=G(-W/K,...D);return l.strokeStyle=h,l.beginPath(),f?(l.moveTo(0,x),l.lineTo(H,x)):(l.moveTo(x,0),l.lineTo(x,H)),l.stroke(),this}function Pe(n,e={}){let[t,o]=n;t=Math.abs(t);const r=o+t,i=r!==0?t/r:0;return{fold:1,...e,cycles:r,playhead:i}}const Qe=(n={})=>(e,t,o,r)=>oe({ctx:e,time:t,haps:o,...Pe(r,n)});O.prototype.punchcard=function(n){return this.onPaint(Qe(n))};O.prototype.wordfall=function(n){return this.punchcard({vertical:1,labels:1,stroke:0,fillActive:1,active:"white",...n})};function ft(n){const{drawTime:e,...t}=n;oe({...Pe(e),...t})}function Xe(n,e,t,o){const r=(n-90)*Math.PI/180;return[t+Math.cos(r)*e,o+Math.sin(r)*e]}const me=(n,e,t,o,r=0)=>Xe((n+r)*360,e*n,t,o);function pe(n){let{ctx:e,from:t=0,to:o=3,margin:r=50,cx:i=100,cy:a=100,rotate:c=0,thickness:s=r/2,color:p=$().foreground,cap:d="round",stretch:h=1,fromOpacity:g=1,toOpacity:u=1}=n;t*=h,o*=h,c*=h,e.lineWidth=s,e.lineCap=d,e.strokeStyle=p,e.globalAlpha=g,e.beginPath();let[v,y]=me(t,r,i,a,c);e.moveTo(v,y);const P=1/60;let f=t;for(;f<=o;){const[q,k]=me(f,r,i,a,c);e.globalAlpha=(f-t)/(o-t)*u,e.lineTo(q,k),f+=P}e.stroke()}function Ye(n){let{stretch:e=1,size:t=80,thickness:o=t/2,cap:r="butt",inset:i=3,playheadColor:a="#ffffff",playheadLength:c=.02,playheadThickness:s=o,padding:p=0,steady:d=1,activeColor:h=$().foreground,inactiveColor:g=$().gutterForeground,colorizeInactive:u=0,fade:v=!0,ctx:y,time:P,haps:f,drawTime:q,id:k}=n;k&&(f=f.filter(A=>A.hasTag(k)));const[b,w]=[y.canvas.width,y.canvas.height];y.clearRect(0,0,b*2,w*2);const[T,I]=[b/2,w/2],F={margin:t/e,cx:T,cy:I,stretch:e,cap:r,thickness:o},E={...F,thickness:s,from:i-c,to:i,color:a},[l]=q,L=d*P;f.forEach(A=>{const R=A.whole.begin<=P&&A.endClipped>P,W=A.whole.begin-P+i,X=A.endClipped-P+i-p,N=A.value?.color||h,H=u||R?N:g,D=v?1-Math.abs((A.whole.begin-P)/l):1;pe({ctx:y,...F,from:W,to:X,rotate:L,color:H,fromOpacity:D,toOpacity:D})}),pe({ctx:y,...E,rotate:L})}O.prototype.spiral=function(n={}){return this.onPaint((e,t,o,r)=>Ye({ctx:e,time:t,haps:o,drawTime:r,...n}))};const Be=$e(36),ge=(n,e,t,o)=>{o=o*Math.PI*2;const r=Math.sin(o)*t+n,i=Math.cos(o)*t+e;return[r,i]},ye=(n,e)=>.5-Math.log2(n/e)%1;function Ue({haps:n,ctx:e,id:t,hapcircles:o=1,circle:r=0,edo:i=12,root:a=Be,thickness:c=3,hapRadius:s=6,mode:p="flake",margin:d=10}={}){const h=p==="polygon",g=p==="flake",u=e.canvas.width,v=e.canvas.height;e.clearRect(0,0,u,v);const y=$().foreground,f=Math.min(u,v)/2-c/2-s-d,q=u/2,k=v/2;t&&(n=n.filter(w=>w.hasTag(t))),e.strokeStyle=y,e.fillStyle=y,e.globalAlpha=1,e.lineWidth=c,r&&(e.beginPath(),e.arc(q,k,f,0,2*Math.PI),e.stroke()),i&&(Array.from({length:i},(w,T)=>{const I=ye(a*Math.pow(2,T/i),a),[F,E]=ge(q,k,f,I);e.beginPath(),e.arc(F,E,s,0,2*Math.PI),e.fill()}),e.stroke());let b=[];e.lineWidth=s,n.forEach(w=>{let T;try{T=De(w)}catch{return}const I=ye(T,a),[F,E]=ge(q,k,f,I),l=w.value.color||y;e.strokeStyle=l,e.fillStyle=l;const{velocity:L=1,gain:A=1}=w.value||{},R=L*A;e.globalAlpha=R,b.push([F,E,I,l,R]),e.beginPath(),o&&(e.moveTo(F+s,E),e.arc(F,E,s,0,2*Math.PI),e.fill()),g&&(e.moveTo(q,k),e.lineTo(F,E)),e.stroke()}),e.strokeStyle=y,e.globalAlpha=1,h&&b.length&&(b=b.sort((w,T)=>w[2]-T[2]),e.beginPath(),e.moveTo(b[0][0],b[0][1]),b.forEach(([w,T,I,F,E])=>{e.strokeStyle=F,e.globalAlpha=E,e.lineTo(w,T)}),e.lineTo(b[0][0],b[0][1]),e.stroke())}O.prototype.pitchwheel=function(n={}){let{ctx:e=te(),id:t=1}=n;return this.tag(t).onPaint((o,r,i)=>Ue({...n,time:r,ctx:e,haps:i.filter(a=>a.isActive(r)),id:t}))};let C=[],z=0;const ee=4;let Ve=n=>{let e=[],t={get(){return t.lc||t.listen(()=>{})(),t.value},lc:0,listen(o){return t.lc=e.push(o),()=>{for(let i=z+ee;i<C.length;)C[i]===o?C.splice(i,ee):i+=ee;let r=e.indexOf(o);~r&&(e.splice(r,1),--t.lc||t.off())}},notify(o,r){let i=!C.length;for(let a of e)C.push(a,t.value,o,r);if(i){for(z=0;z<C.length;z+=ee)C[z](C[z+1],C[z+2],C[z+3]);C.length=0}},off(){},set(o){let r=t.value;r!==o&&(t.value=o,t.notify(r))},subscribe(o){let r=t.listen(o);return o(t.value),r},value:n};return t},dt=(n={})=>{let e=Ve(n);return e.setKey=function(t,o){let r=e.value;typeof o>"u"&&t in e.value?(e.value={...e.value},delete e.value[t],e.notify(r,t)):e.value[t]!==o&&(e.value={...e.value,[t]:o},e.notify(r,t))},e};export{Ze as D,je as F,oe as _,rt as a,lt as b,Je as c,xe as d,$ as e,at as f,te as g,ot as h,et as i,Pe as j,Qe as k,ft as l,ct as m,Ue as n,dt as o,ut as p,Ve as q,it as r,st as s,nt as w,be as x,tt as y,ht as z};
